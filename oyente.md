
# Making Smart Contracts Smarter 

区块链是一种分布式账本技术。通常来讲，区块链可以被理解为一种按照时间顺序，将数据区块前后链接形成的特定数据结构，同时采用密码学的方法保证其不可篡改性。它可以被认为是一个分布式的数据库，全网分布式节点不仅参与数据存储，还同时参与数据记录与维护，并通过共识算法达成一致。区块链最早在2008年由Satoshi Nakamoto所发表的论文《Bitcoin: A peer-to-peer electronic cash system》提出。作为比特币、以太坊等数字货币的底层核心技术，区块链可以有效解决P2P网络中的共识问题，具有去中心化、去信任、数据不可篡改等特点。区块链突破了传统社会依赖于可信第三方的信任模式，通过共识机制解决去中心化系统中分布式节点间的信任问题，实现了信息的可信传播，是对信任模式和信息传播机制的重大突破。区块链在其诞生之初并没有受到广泛的关注，但随着比特币网络长期的稳定运行，其底层技术渐渐引起了各界广泛关注。早期，受比特币影响，人们将大部分研究经历放在区块链技术在加密货币领域的应用。但随着研究深入，人们发现区块链可以在任何需要建立分布式信任关系的领域颠覆传统技术，发挥巨大作用。近五年来区块链技术相关论文数量急速增加，覆盖医疗、保险、信息科学、电子商务等众多学科。

比特币开启了区块链1.0时代。而智能合约的诞生被视为区块链2.0时代的开端，极大地扩展了区块链的应用场景与现实意义。目前，世界最大的可运行智能合约的区块链系统为以太坊。以太坊系统发展迅猛，开发者社区不断扩大，其安全性也逐渐受到人们的重视。本文基于符号执行技术，开发了一个称为oyente的工具，可以对以太坊上运行的智能合约进行安全检测。

## 背景介绍

智能合约可以处理大量数字货币，目前以太坊中有超过200个利用智能合约实现的代币系统市值过亿。与传统的分布式平台不同，智能合约在开放的网络中运行，在巨大的利益诱惑下，很容易受到攻击。尽管合约一旦部署，就需要严格遵循代码逻辑运行，但攻击者仍可以利用特殊参数、调用顺序或是时间戳等区块链状态，对运行结果造成影响。为了避免合约受到攻击，开发人员需要对合约代码的微妙语义有充分的把握，熟悉可能存在的各种漏洞，并加以预防。然而目前智能合约的安全性尚未受到开发者重视。经典的The Dao事件中，黑客攻击智能合约盗取了高达六千万美元的以太币，并造成了以太坊链的分叉，后果十分严重。而据现有检测结果来看，以太坊中可能有超过90%的合约存在明显漏洞。由于智能合约不能像普通计算机系统一样进行升级和修改，故需要在合约发布前进行充分的测试与审核。对潜在安全威胁进行充分分析，有助于开发者在编码阶段对规避漏洞产生，也有助于后续研究的进一步展开。此外，随着合约功能日益复杂，人力往往难以对代码安全性进行充分考量，故需要开发自动化工具来协助完成这一检测过程。

## 技术介绍

### 以太坊

以太坊延续了经典的区块链结构，主要由数据层、网络层、共识层、应用层四个部分构成。
- 数据层：数据层主要由底层数据区块与其链式结构构成，区块间以哈希摘要相连，并以Merkle树形式存储与索引，保障了区块数据的可溯源性和完整性；
- 网络层：网络层以扁平式拓扑结构的P2P网络为基础模型，实现了交易验证和数据传播机制，以保障以太坊分布式节点间的可信数据传递。
- 共识层与激励层：该层是区块链系统的核心组件，保障了分布式账本的一致性和真实性。
- 应用层：应用层通过EVM虚拟机，对智能合约的运行进行支持，以实现以太坊上各种复杂的业务逻辑。

### 智能合约

以太坊智能合约由基于栈的字节码构成，这种低级别的字节码语言被称为EVM代码（或以太坊虚拟机代码）。代码由字节序列构成，每个字节对应一种操作。每次执行操作后，程序计数器数值加一，直到出错或遇到STOP、RETURN指令时停止。以太坊指令可以访问三种数据存储：
- 运行时栈：先进后出的数据存储，与传统计算系统中的栈概念相似。
- 内存：可无限扩展的临时存储空间，每次执行后被清空。
- 长期存储：一种键-值形式的存储空间，每次运行结束后，长期存储的内容不被清零。

## 攻击介绍

本文的一大贡献就是对已经爆发的几类针对智能合约漏洞的攻击进行了梳理。主要有以下几种攻击：

- 交易顺序依赖：不同的交易顺序可能导致不同结果。比如在悬赏中，悬赏者更改悬赏金额前后，参与者获得的报酬是不同的。攻击者可以监听网络中的事件，当发现正确结果时，迅速提交降低悬赏金额的交易，并支付更高的手续费，这样降低酬劳的操作很可能被优先处理，并使攻击者受益。此外，矿工有权限调整一个区块内交易发生的顺序，同样可以实现相似的攻击。
- 时间戳依赖：每个区块都含有一个时间戳，记录其诞生时间。智能合约常使用时间戳作为随机数产生的种子，或付款等事件触发的条件。由于广播造成的时延，以太坊网络对时间戳的误差有一定容忍度，矿工可以在一定范围内改变时间戳以获益。为了避免这种攻击，合约可以采用区块编号等无法被修改的参数代替时间戳。
- 异常处理缺失：以太坊中，智能合约可以通过send指令调用其他合约。如果被调用函数中发生了异常，会返回false值并终止执行。然而使用send指令时，调用者需要主动检查是否发生了异常。
- 重入攻击：指合约中的原子性事件由于并发的存在而遭到破坏。The Dao事件就是一个经典的重入攻击案例。

## 系统设计

作者设计了一个叫oyente的工具来对上述智能合约中的上述漏洞进行检测。工具依赖于符号执行技术。符号执行将程序变量的值表示为输入符号值的符号表达式。每个符号路径都有一个路径条件，是通过累加约束条件构建的符号输入的公式，要想到达当前的路径，则当前路径对应的路径条件必须得到满足。作者解释说，选择符号执行是因为它可以静态地推导出程序​​的所有路径。对于智能合约来说，由于代码一般比较短小，因此在符号执行中很难出现路劲爆炸的情况，是一个比较理性地运用符号执行的场景。此外，由于智能合约运行在以太坊上，要想对其进行动态测试是很困难的，这也是作者选择静态符号执行的原因。

Oyente遵循模块化设计，主要由CFGBuilder、Explorer、CoreAnalysis 和 Validator四个模块组成。

- CFGBuilder：为目标合约代码构建一个较为基础CFG图。该图包含了一些基本块作为顶点，一些可以确定的跳转路径作为边。静态分析阶段还有一些边无法确定，所以这个CFG图会在符号执行阶段进行补充。
- Explorer：该模块从上述CFG的入口节点开始，逐个遍历并可能会执行一些符号状态。Explorer的核心是一个解释器循环，循环获得一个运行状态，然后在该状态的上下文中象征性地执行单个指令。当检测到没有剩余状态或达到用户定义的超时，循环才会终止。
- CoreAnalysis：该模块是漏洞分析的核心，作者针对每一种需要检测漏洞都在该模块下实现了一个检测子模块，用于检测对应的漏洞。
- Validator：该模块的设计目的是消除误报。CoreAnalysis所检测到的合约漏洞都会标记为假阳性，并送入到该模块进行误报分析。
